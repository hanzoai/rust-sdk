name: Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Label PRs based on files changed
  label:
    name: Label PR
    runs-on: ubuntu-latest
    steps:
      - uses: actions/labeler@v4
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"

  # Check PR title follows conventional commits
  pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}" should start with a capital letter.

  # Check commit messages
  commits:
    name: Check Commits
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check commit messages
        uses: wagoid/commitlint-github-action@v6

  # Size labeling
  size:
    name: Label Size
    runs-on: ubuntu-latest
    steps:
      - uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: '10'
          s_label: 'size/S'
          s_max_size: '100'
          m_label: 'size/M'
          m_max_size: '300'
          l_label: 'size/L'
          l_max_size: '1000'
          xl_label: 'size/XL'
          message_if_xl: >
            This PR is very large. Please consider breaking it into smaller PRs.

  # Security check for dependencies
  security:
    name: Security Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'

  # License check
  license:
    name: License Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check licenses
        uses: EmbarkStudios/cargo-deny-action@v1
        with:
          command: check licenses

  # API compatibility check
  semver:
    name: Semver Check
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: obi1kenobi/cargo-semver-checks-action@v2
        with:
          package: hanzo-kbs, hanzo-pqc, hanzo-message-primitives

  # PR comment with test results
  comment:
    name: PR Comment
    runs-on: ubuntu-latest
    needs: [pr-title, commits, security, license, semver]
    if: always()
    steps:
      - uses: actions/checkout@v4
      - name: Comment PR
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ## Pull Request Check Results

            | Check | Status |
            |-------|--------|
            | Title | ${{ needs.pr-title.result == 'success' && '✅' || '❌' }} |
            | Commits | ${{ needs.commits.result == 'success' && '✅' || '❌' }} |
            | Security | ${{ needs.security.result == 'success' && '✅' || '❌' }} |
            | Licenses | ${{ needs.license.result == 'success' && '✅' || '❌' }} |
            | Semver | ${{ needs.semver.result == 'success' && '✅' || '❌' }} |

            Please ensure all checks pass before merging.
          comment_tag: checks
          mode: recreate