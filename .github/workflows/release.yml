name: Release & Publish

on:
  push:
    tags:
      - 'v*'
      - 'hanzo-message-primitives-*'
      - 'hanzo-pqc-*'
      - 'hanzo-kbs-*'
  workflow_dispatch:
    inputs:
      crate:
        description: 'Crate to publish (hanzo-message-primitives, hanzo-pqc, hanzo-kbs, or all)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - hanzo-message-primitives
          - hanzo-pqc
          - hanzo-kbs
      dry_run:
        description: 'Dry run (do not actually publish)'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Determine which crates to publish
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      publish_message_primitives: ${{ steps.determine.outputs.publish_message_primitives }}
      publish_pqc: ${{ steps.determine.outputs.publish_pqc }}
      publish_kbs: ${{ steps.determine.outputs.publish_kbs }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
      - name: Determine crates to publish
        id: determine
        run: |
          TAG="${{ github.ref_name }}"
          echo "Processing tag: $TAG"
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            case "${{ github.event.inputs.crate }}" in
              "all")
                echo "publish_message_primitives=true" >> $GITHUB_OUTPUT
                echo "publish_pqc=true" >> $GITHUB_OUTPUT
                echo "publish_kbs=true" >> $GITHUB_OUTPUT
                ;;
              "hanzo-message-primitives")
                echo "publish_message_primitives=true" >> $GITHUB_OUTPUT
                echo "publish_pqc=false" >> $GITHUB_OUTPUT
                echo "publish_kbs=false" >> $GITHUB_OUTPUT
                ;;
              "hanzo-pqc")
                echo "publish_message_primitives=false" >> $GITHUB_OUTPUT
                echo "publish_pqc=true" >> $GITHUB_OUTPUT
                echo "publish_kbs=false" >> $GITHUB_OUTPUT
                ;;
              "hanzo-kbs")
                echo "publish_message_primitives=false" >> $GITHUB_OUTPUT
                echo "publish_pqc=false" >> $GITHUB_OUTPUT
                echo "publish_kbs=true" >> $GITHUB_OUTPUT
                ;;
            esac
          else
            # Tag-based release - match Python SDK pattern
            if [[ "$TAG" == hanzo-message-primitives-* ]]; then
              echo "publish_message_primitives=true" >> $GITHUB_OUTPUT
              echo "publish_pqc=false" >> $GITHUB_OUTPUT
              echo "publish_kbs=false" >> $GITHUB_OUTPUT
            elif [[ "$TAG" == hanzo-pqc-* ]]; then
              echo "publish_message_primitives=false" >> $GITHUB_OUTPUT
              echo "publish_pqc=true" >> $GITHUB_OUTPUT
              echo "publish_kbs=false" >> $GITHUB_OUTPUT
            elif [[ "$TAG" == hanzo-kbs-* ]]; then
              echo "publish_message_primitives=false" >> $GITHUB_OUTPUT
              echo "publish_pqc=false" >> $GITHUB_OUTPUT
              echo "publish_kbs=true" >> $GITHUB_OUTPUT
            elif [[ "$TAG" == v* ]]; then
              # General version tag publishes all packages
              echo "publish_message_primitives=true" >> $GITHUB_OUTPUT
              echo "publish_pqc=true" >> $GITHUB_OUTPUT
              echo "publish_kbs=true" >> $GITHUB_OUTPUT
            else
              echo "Unknown tag pattern: $TAG"
              echo "publish_message_primitives=false" >> $GITHUB_OUTPUT
              echo "publish_pqc=false" >> $GITHUB_OUTPUT
              echo "publish_kbs=false" >> $GITHUB_OUTPUT
            fi
          fi
          
          echo "Publishing decisions:"
          echo "  message-primitives: $(grep publish_message_primitives $GITHUB_OUTPUT || echo 'false')"
          echo "  pqc: $(grep publish_pqc $GITHUB_OUTPUT || echo 'false')"
          echo "  kbs: $(grep publish_kbs $GITHUB_OUTPUT || echo 'false')"
      - name: Extract version
        id: version
        run: |
          TAG="${{ github.ref_name }}"
          VERSION=""
          
          # Extract version from different tag patterns
          if [[ "$TAG" =~ ^v([0-9]+\.[0-9]+\.[0-9]+.*) ]]; then
            VERSION="${BASH_REMATCH[1]}"
          elif [[ "$TAG" =~ -v?([0-9]+\.[0-9]+\.[0-9]+.*) ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            VERSION="unknown"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION from tag: $TAG"

  # Build and test release artifacts
  build:
    name: Build Release
    needs: prepare
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
      - name: Install musl tools
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: sudo apt-get install -y musl-tools
      - name: Build release
        run: cargo build --release --all --target ${{ matrix.target }}
      - name: Run tests
        if: matrix.target != 'aarch64-apple-darwin'  # Can't run aarch64 tests on x86_64
        run: cargo test --release --all --target ${{ matrix.target }}

  # Verify crate packages
  verify:
    name: Verify Packages
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Verify hanzo-message-primitives
        if: needs.prepare.outputs.publish_message_primitives == 'true'
        run: |
          cd crates/hanzo-message-primitives
          cargo publish --dry-run
      - name: Verify hanzo-pqc
        if: needs.prepare.outputs.publish_pqc == 'true'
        run: |
          cd crates/hanzo-pqc
          cargo publish --dry-run
      - name: Verify hanzo-kbs
        if: needs.prepare.outputs.publish_kbs == 'true'
        run: |
          cd crates/hanzo-kbs
          cargo publish --dry-run

  # Generate changelog
  changelog:
    name: Generate Changelog
    needs: [prepare, verify]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Generate changelog
        uses: orhun/git-cliff-action@v2
        id: git-cliff
        with:
          config: .github/cliff.toml
          args: -v --latest --strip header
        env:
          OUTPUT: CHANGELOG.md
      - name: Upload changelog
        uses: actions/upload-artifact@v3
        with:
          name: changelog
          path: CHANGELOG.md

  # Publish to crates.io
  publish:
    name: Publish Crates
    needs: [prepare, build, verify, changelog]
    runs-on: ubuntu-latest
    if: github.event.inputs.dry_run != 'true'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Login to crates.io
        run: cargo login ${{ secrets.CARGO_REGISTRY_TOKEN }}
      
      # Publish in dependency order
      - name: Publish hanzo-message-primitives
        if: needs.prepare.outputs.publish_message_primitives == 'true'
        run: |
          cd crates/hanzo-message-primitives
          cargo publish --no-verify
          # Wait for crates.io to index
          sleep 30
      
      - name: Publish hanzo-pqc
        if: needs.prepare.outputs.publish_pqc == 'true'
        run: |
          cd crates/hanzo-pqc
          cargo publish --no-verify
          sleep 30
      
      - name: Publish hanzo-kbs
        if: needs.prepare.outputs.publish_kbs == 'true'
        run: |
          cd crates/hanzo-kbs
          cargo publish --no-verify

  # Create GitHub Release
  release:
    name: Create Release
    needs: [prepare, publish]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
      - name: Download changelog
        uses: actions/download-artifact@v3
        with:
          name: changelog
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(needs.prepare.outputs.version, '-') }}
          files: |
            LICENSE-MIT
            LICENSE-APACHE
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Update documentation
  docs:
    name: Deploy Documentation
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Build documentation
        run: |
          cargo doc --all --no-deps --all-features
          echo '<meta http-equiv="refresh" content="0; url=hanzo_kbs/index.html">' > target/doc/index.html
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./target/doc
          cname: rust-sdk.hanzo.ai

  # Notify on completion
  notify:
    name: Notify Completion
    needs: [prepare, publish, release, docs]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send notification
        uses: 8398a7/action-slack@v3
        if: env.SLACK_WEBHOOK_URL != ''
        with:
          status: ${{ job.status }}
          text: |
            Release ${{ needs.prepare.outputs.version }} completed!
            Published crates:
            - hanzo-message-primitives: ${{ needs.prepare.outputs.publish_message_primitives }}
            - hanzo-pqc: ${{ needs.prepare.outputs.publish_pqc }}
            - hanzo-kbs: ${{ needs.prepare.outputs.publish_kbs }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}