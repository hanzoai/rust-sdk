name: Scheduled Checks

on:
  schedule:
    # Run every Monday at 8 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rustsec/audit-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Create issue if vulnerabilities found
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Security vulnerabilities detected',
              body: 'The scheduled security audit found vulnerabilities. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.',
              labels: ['security', 'critical']
            })

  # Dependency updates check
  dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install cargo-outdated
        run: cargo install cargo-outdated
      - name: Check outdated dependencies
        id: outdated
        run: |
          OUTDATED=$(cargo outdated --format json --root-deps-only)
          echo "outdated=$OUTDATED" >> $GITHUB_OUTPUT
          if [ "$OUTDATED" != "[]" ]; then
            echo "Found outdated dependencies"
            exit 1
          fi
      - name: Create PR for updates
        if: failure()
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'Update outdated dependencies'
          body: |
            This PR updates outdated dependencies found by the scheduled check.
            
            Please review the changes carefully before merging.
          branch: deps/scheduled-update
          labels: dependencies

  # License compliance
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: EmbarkStudios/cargo-deny-action@v1
        with:
          command: check licenses
      - name: Create issue if license issues found
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'License compliance issues detected',
              body: 'The scheduled license check found issues. Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.',
              labels: ['legal', 'important']
            })

  # Performance regression check
  benchmark:
    name: Performance Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - name: Run benchmarks
        run: |
          cargo bench --all -- --save-baseline current
      - name: Compare with baseline
        continue-on-error: true
        run: |
          # This would compare with a stored baseline
          echo "Benchmark comparison would happen here"

  # MSRV check
  msrv:
    name: MSRV Verification
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.70.0  # Current MSRV
      - name: Check MSRV
        run: |
          cargo check --all
          cargo test --all

  # Documentation freshness
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Check documentation
        env:
          RUSTDOCFLAGS: -D warnings
        run: |
          cargo doc --all --no-deps --all-features
      - name: Check for broken links
        run: |
          cargo install cargo-deadlinks
          cargo deadlinks --check-http

  # Fuzz testing
  fuzz:
    name: Fuzz Testing
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@nightly
      - name: Install cargo-fuzz
        run: cargo install cargo-fuzz
      - name: Run fuzz tests
        run: |
          # Run each fuzzer for a short time
          for fuzz_target in kbs_attestation pqc_kem pqc_signature; do
            echo "Fuzzing $fuzz_target..."
            cd crates/hanzo-kbs
            # Run for 60 seconds
            cargo +nightly fuzz run $fuzz_target -- -max_total_time=60 || true
            cd ../..
          done

  # Notify results
  notify:
    name: Notify Results
    needs: [security-audit, dependencies, license-check, benchmark, msrv, docs, fuzz]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Send summary
        uses: 8398a7/action-slack@v3
        if: env.SLACK_WEBHOOK_URL != ''
        with:
          status: custom
          custom_payload: |
            {
              text: "Scheduled checks completed",
              attachments: [{
                color: '${{ contains(needs.*.result, 'failure') && 'danger' || 'good' }}',
                fields: [
                  { title: 'Security Audit', value: '${{ needs.security-audit.result }}', short: true },
                  { title: 'Dependencies', value: '${{ needs.dependencies.result }}', short: true },
                  { title: 'License Check', value: '${{ needs.license-check.result }}', short: true },
                  { title: 'Benchmarks', value: '${{ needs.benchmark.result }}', short: true },
                  { title: 'MSRV', value: '${{ needs.msrv.result }}', short: true },
                  { title: 'Documentation', value: '${{ needs.docs.result }}', short: true },
                  { title: 'Fuzz Testing', value: '${{ needs.fuzz.result }}', short: true }
                ]
              }]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}