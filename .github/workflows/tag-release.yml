name: Tag Release Info

on:
  create:

jobs:
  tag-info:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Parse tag and generate release notes
        id: parse_tag
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Tag: $TAG"
          
          # Determine package and version
          if [[ "$TAG" == hanzo-message-primitives-* ]]; then
            PACKAGE="hanzo-message-primitives"
            VERSION="${TAG#hanzo-message-primitives-v}"
          elif [[ "$TAG" == hanzo-pqc-* ]]; then
            PACKAGE="hanzo-pqc"
            VERSION="${TAG#hanzo-pqc-v}"
          elif [[ "$TAG" == hanzo-kbs-* ]]; then
            PACKAGE="hanzo-kbs"
            VERSION="${TAG#hanzo-kbs-v}"
          elif [[ "$TAG" == v* ]]; then
            PACKAGE="all"
            VERSION="${TAG#v}"
          else
            echo "Unknown tag pattern: $TAG"
            exit 0
          fi
          
          echo "package=$PACKAGE" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$TAG" >> $GITHUB_OUTPUT
      
      - name: Create release notes
        if: steps.parse_tag.outputs.package != ''
        uses: actions/github-script@v7
        with:
          script: |
            const package = '${{ steps.parse_tag.outputs.package }}';
            const version = '${{ steps.parse_tag.outputs.version }}';
            const tag = '${{ steps.parse_tag.outputs.tag }}';
            
            let title, body;
            
            if (package === 'all') {
              title = `Hanzo Rust SDK v${version}`;
              body = `## ðŸš€ Release v${version}
              
              This release includes updates to all packages in the Hanzo Rust SDK.
              
              ### Packages Released
              - âœ… **hanzo-message-primitives** v${version}
              - âœ… **hanzo-pqc** v${version}
              - âœ… **hanzo-kbs** v${version}
              
              ### Installation
              
              Add to your \`Cargo.toml\`:
              \`\`\`toml
              [dependencies]
              hanzo-kbs = "${version}"
              hanzo-pqc = "${version}"
              \`\`\`
              
              ### What's Changed
              See [CHANGELOG.md](https://github.com/hanzoai/rust-sdk/blob/${tag}/CHANGELOG.md) for details.
              `;
            } else {
              title = `${package} v${version}`;
              body = `## ðŸš€ Release ${package} v${version}
              
              ### Installation
              
              Add to your \`Cargo.toml\`:
              \`\`\`toml
              [dependencies]
              ${package} = "${version}"
              \`\`\`
              
              ### Crates.io
              View on crates.io: [${package}](https://crates.io/crates/${package}/${version})
              
              ### Documentation
              View documentation: [docs.rs](https://docs.rs/${package}/${version})
              
              ### What's Changed
              See [CHANGELOG.md](https://github.com/hanzoai/rust-sdk/blob/${tag}/CHANGELOG.md) for details.
              `;
            }
            
            // Create release
            try {
              await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: tag,
                name: title,
                body: body,
                draft: false,
                prerelease: version.includes('-'),
              });
              
              console.log(`Created release for ${package} v${version}`);
            } catch (error) {
              console.log('Release may already exist:', error.message);
            }