name: Version Check

on:
  pull_request:
    paths:
      - '**/Cargo.toml'
  workflow_dispatch:

jobs:
  check-versions:
    name: Check Version Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Check inter-crate dependencies
        run: |
          set -e
          
          echo "Checking inter-crate dependency versions..."
          
          # Extract versions from Cargo.toml files
          MSG_PRIMITIVES_VERSION=$(grep '^version = ' crates/hanzo-message-primitives/Cargo.toml | cut -d'"' -f2)
          PQC_VERSION=$(grep '^version = ' crates/hanzo-pqc/Cargo.toml | cut -d'"' -f2)
          KBS_VERSION=$(grep '^version = ' crates/hanzo-kbs/Cargo.toml | cut -d'"' -f2)
          
          echo "Current versions:"
          echo "  hanzo-message-primitives: $MSG_PRIMITIVES_VERSION"
          echo "  hanzo-pqc: $PQC_VERSION"
          echo "  hanzo-kbs: $KBS_VERSION"
          
          # Check hanzo-pqc dependencies
          if grep -q 'hanzo-message-primitives' crates/hanzo-pqc/Cargo.toml; then
            PQC_MSG_DEP=$(grep 'hanzo-message-primitives = {' crates/hanzo-pqc/Cargo.toml | grep -o 'version = "[^"]*"' | cut -d'"' -f2)
            if [[ -n "$PQC_MSG_DEP" ]]; then
              echo "hanzo-pqc depends on hanzo-message-primitives $PQC_MSG_DEP"
              if [[ "$PQC_MSG_DEP" != "$MSG_PRIMITIVES_VERSION" ]]; then
                echo "WARNING: Version mismatch - hanzo-pqc expects hanzo-message-primitives $PQC_MSG_DEP but found $MSG_PRIMITIVES_VERSION"
              fi
            fi
          fi
          
          # Check hanzo-kbs dependencies
          if grep -q 'hanzo-message-primitives' crates/hanzo-kbs/Cargo.toml; then
            KBS_MSG_DEP=$(grep 'hanzo-message-primitives = {' crates/hanzo-kbs/Cargo.toml | grep -o 'version = "[^"]*"' | cut -d'"' -f2)
            if [[ -n "$KBS_MSG_DEP" ]]; then
              echo "hanzo-kbs depends on hanzo-message-primitives $KBS_MSG_DEP"
              if [[ "$KBS_MSG_DEP" != "$MSG_PRIMITIVES_VERSION" ]]; then
                echo "WARNING: Version mismatch - hanzo-kbs expects hanzo-message-primitives $KBS_MSG_DEP but found $MSG_PRIMITIVES_VERSION"
              fi
            fi
          fi
          
          if grep -q 'hanzo-pqc' crates/hanzo-kbs/Cargo.toml; then
            KBS_PQC_DEP=$(grep 'hanzo-pqc = {' crates/hanzo-kbs/Cargo.toml | grep -o 'version = "[^"]*"' | cut -d'"' -f2)
            if [[ -n "$KBS_PQC_DEP" ]]; then
              echo "hanzo-kbs depends on hanzo-pqc $KBS_PQC_DEP"
              if [[ "$KBS_PQC_DEP" != "$PQC_VERSION" ]]; then
                echo "WARNING: Version mismatch - hanzo-kbs expects hanzo-pqc $KBS_PQC_DEP but found $PQC_VERSION"
              fi
            fi
          fi
          
      - name: Generate version report
        id: version_report
        run: |
          # Create a detailed version report
          cat > version-report.md << EOF
          ## ðŸ“¦ Version Report
          
          | Crate | Version |
          |-------|---------|
          | hanzo-message-primitives | $(grep '^version = ' crates/hanzo-message-primitives/Cargo.toml | cut -d'"' -f2) |
          | hanzo-pqc | $(grep '^version = ' crates/hanzo-pqc/Cargo.toml | cut -d'"' -f2) |
          | hanzo-kbs | $(grep '^version = ' crates/hanzo-kbs/Cargo.toml | cut -d'"' -f2) |
          
          ### Dependency Graph
          \`\`\`
          hanzo-kbs
          â”œâ”€â”€ hanzo-pqc
          â”‚   â””â”€â”€ hanzo-message-primitives
          â””â”€â”€ hanzo-message-primitives
          \`\`\`
          
          ### Release Instructions
          
          To release a single package:
          \`\`\`bash
          ./scripts/release-package.sh <package-name> <version>
          \`\`\`
          
          To release all packages:
          \`\`\`bash
          ./scripts/release-package.sh all <version>
          \`\`\`
          EOF
          
          echo "report<<EOF" >> $GITHUB_OUTPUT
          cat version-report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ${{ steps.version_report.outputs.report }}
          comment_tag: version_check
          mode: recreate